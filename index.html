<html>
<head>
	<meta charset="UTF-8">
	<title></title>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
	<style>
	#canvas, input {
		border: 1px solid gray;
		margin: 0 auto;
	}

	#canvas {
		width:640px;
		height: 640px;
	}

	</style>
</head>
<body>
	<div class="container">
		<div class="row py-1">
			<div  style="margin: 0 auto;">
				<a class="btn btn-primary" href="#" id="save-button" >Save</a>
				<a id="link" target="_blank"></a>
			</div>
		</div>
		<div class="row py-3">
			<canvas id="canvas" width="640" height="640">				
			</canvas>
		</div>
		<div class="row py-1">
			<div class="col-6">
				<label>
					Image:
					<input type="file" id="file-input" class="form-control">
				</label>

				<label>
					Background Color:
					<input id="back-color-input" 
							type="color"
							placeholder="Background Color"
							value="#dad3b6"
							class="form-control my-1"/>
				</label>
			</div>
			<div class="col-6">
				<label>
					Watermark:
				<input id="text-input" 
						type="text"
						placeholder="Text"
						class="form-control my-1"/>
					</label>
				<label>
					Text Size:
					<input id="text-size-input" 
							type="number"
							placeholder="Font Size"
							value="12"
							min="8"
							max="48"
							class="form-control my-1"/>
				</label>

				<label>
					Text Opacity:
					<input id="text-opacity-input" 
							type="number"
							value="1"
							min="0.1"
							max="1"
							step="0.1"
							class="form-control my-1"/>
				</label>

				<label>
					Text Color:
					<input id="text-color-input" 
							type="color"
							placeholder="Font Color"
							value="#000000"
							class="form-control my-1"/>
				</label>
			</div>	
		</div>
	</div>
	

	<script>
		var canvasWidth = 640;
		var canvasHeight = 640;
		var canvas = document.getElementById('canvas');
		var ctx = canvas.getContext('2d');
		var imageInput = document.getElementById("file-input");
		var colorInput = document.getElementById("back-color-input");
		var overlayInput = document.getElementById("overlay-input");
		var textInput = document.getElementById("text-input");
		var textSizeInput = document.getElementById("text-size-input");
		var textColorInput = document.getElementById("text-color-input");
		var textOpacityInput = document.getElementById("text-opacity-input");
		var saveButton = document.getElementById("save-button");
		var img = new Image();
		var mark = new Image();
		var text = textInput.value;
		var textSize = textSizeInput.value;
		var textX = 0;
		var textY = 0;
		var color = "#dad3b6";
		var textColor = "#000000";
		var textOpacity = 1;
		var fileName = "";

		function resetCanvas() {
			ctx.fillStyle = color;
			ctx.fillRect(0, 0, canvasWidth, canvasHeight);
		}

		function drawImage() {
			var vPad = 32;
			var hPad = 32;
			var dstWidth = canvasWidth - hPad * 2;
			var dstHeight = canvasHeight - vPad * 2;
			var srcRatio = img.width / img.height;
			var dstRatio = dstWidth / dstHeight;

		    var scaleFactor;
		    if (srcRatio < dstRatio)
		        scaleFactor = dstHeight / img.height;
		    else
		        scaleFactor = dstWidth / img.width;

		    var totalWidth = img.width * scaleFactor;
		    var totalHeight = img.height * scaleFactor;

		    ctx.drawImage(img,
		    hPad + (dstWidth - totalWidth) / 2,
		    vPad + (dstHeight - totalHeight) / 2,
		    img.width * scaleFactor,
		    img.height * scaleFactor);
		}

		function drawOverlay() {
			ctx.fillStyle = textColor;
			ctx.font = textSize + "px sans-serif";
			ctx.globalAlpha = textOpacity;
			ctx.fillText(text, textX, textY);
			ctx.globalAlpha = 1;
		}

		function render() {			
			resetCanvas();
			drawImage();			
			drawOverlay();
		}
		imageInput.addEventListener("change", function(e) {			
			img.onload = render;
			fileName = e.target.files[0].name;
			img.src = URL.createObjectURL(e.target.files[0]);
		});

		function onCanvasGesture(e) {
			textX = e.offsetX;
			textY = e.offsetY;
			render();
		}

		canvas.addEventListener("click", onCanvasGesture);
		textInput.addEventListener("change", function() {
			text = textInput.value;
			render();
		});
		textSizeInput.addEventListener("change", function() {
			textSize = textSizeInput.value;
			render();
		});
		textColorInput.addEventListener("change", function() {
			textColor = textColorInput.value;
			render();
		});
		textOpacityInput.addEventListener("change", function() {
			textOpacity = textOpacityInput.value;
			render();
		});

		colorInput.addEventListener("change", function() {
			color = colorInput.value;
			render();
		});

		saveButton.addEventListener("click", function () {
			//var image = canvas.toDataURL("image/png").replace("image/png", "image/octet-stream");
			//window.location.href=image;

			var link = document.getElementById('link');
		  	link.setAttribute('download', fileName);
		  	link.setAttribute('href', canvas.toDataURL("image/png").replace("image/png", "image/octet-stream"));
		  	link.click();
		});
		
	</script>
</body>
</html>
