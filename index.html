<html>
<head>
	<meta charset="UTF-8">
	<title></title>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
	<style>
	body {
		background: #f3f3f3;
	}
	canvas, input {
		border: 1px solid gray;
		margin: 0 auto;
	}

	#canvas {
		width:640px;
		height: 640px;
	}

	#lightbox {
		position: absolute;
		top:0;
		bottom: 0;
		left: 0;
		right: 0;
		background: black;
		z-index: 1;
		display: none;
	}

	#lightbox > img {
		margin: 10px auto;
		width: 640px;
		height: 640px;
		display: block;
	}

	#lightbox > a.btn {
		margin: 10px auto;
		display: block;
		width: 200px;
	}

	</style>
</head>
<body>
	<div id="lightbox">
		<img id="result"/>
		<a class="btn btn-primary" href="#" id="close-button">Back</a>
	</div>
	<div class="container">		
		<div class="row py-3">
			<canvas id="canvas" width="640" height="640">				
			</canvas>
		</div>
		<div class="row py-1">
			<div class="col-6">
				<label>
					Image:
					<input type="file" id="file-input" class="form-control">
				</label>

				<label>
					Background Color:
					<input id="back-color-input" 
							type="color"
							placeholder="Background Color"
							value="#dad3b6"
							class="form-control my-1"/>
				</label>
			</div>
			<div class="col-6">
				<label>
					Watermark:
				<input id="text-input" 
						type="text"
						placeholder="Text"
						class="form-control my-1"/>
					</label>
				<label>
					Text Size:
					<input id="text-size-input" 
							type="number"
							placeholder="Font Size"
							value="32"
							min="8"
							max="72"
							class="form-control my-1"/>
				</label>

				<label>
					Text Opacity:
					<input id="text-opacity-input" 
							type="number"
							value="1"
							min="0.1"
							max="1"
							step="0.1"
							class="form-control my-1"/>
				</label>

				<label>
					Text Color:
					<input id="text-color-input" 
							type="color"
							placeholder="Font Color"
							value="#000000"
							class="form-control my-1"/>
				</label>
			</div>	
		</div>
		<div class="row py-1">
			<div style="margin: 0 auto;">
				<a class="btn btn-primary" href="#" id="save-button" >Save</a>
				<a id="link" style="display: hidden"></a>
			</div>
		</div>

		<div class="row">
			<canvas id="text-canvas" width="400" height="200">
				
			</canvas>

			<canvas id="text-mask-canvas" width="400" height="200">
				
			</canvas>
		</div>
	</div>
	
	<script>
		var fontSize = 42;
		var width = 400;
		var height = 200;
		var textCanvas = document.getElementById('text-canvas');
		var textCtx = textCanvas.getContext('2d');

		var maskCanvas = document.getElementById('text-mask-canvas');
		var maskCtx = maskCanvas.getContext('2d');

		var text = "test_text";

		maskCtx.fillStyle = "#FFFFFF";
		maskCtx.font = fontSize + "px sans-serif";
		maskCtx.fillRect(0, 0, width, height);
		var textSize = maskCtx.measureText(text);
		maskCtx.fillStyle = "#000000";
		maskCtx.fillText(text, width / 2 - textSize.width / 2, height / 2 + fontSize /2);


		var idata = maskCtx.getImageData(0, 0, width, height);
		var data32 = new Uint32Array(idata.data.buffer);
		var i = 0, len = data32.length;
		while(i < len) {
			data32[i] = data32[i++] << 8;
		} 
		maskCtx.putImageData(idata, 0, 0);

		
  
		var textSize = maskCtx.measureText(text);
		textCtx.font = fontSize + "px sans-serif";
		
		textCtx.fillStyle = "#ffffff";
		textCtx.fillText(text, width / 2 - textSize.width / 2 - 1, height / 2 + fontSize / 2 - 1);
		textCtx.fillStyle = "#000000";
		textCtx.fillText(text, width / 2 - textSize.width / 2 + 1, height / 2 + fontSize / 2 + 1);

		maskCtx.globalCompositeOperation = "source-in";
		//maskCtx.fillStyle = "red";
		//maskCtx.fillRect(0, 0, 200, 200);
		maskCtx.globalAlpha = .7;
		maskCtx.drawImage(textCanvas, 0, 0);
	</script>	

	<script>
		var canvasWidth = 640;
		var canvasHeight = 640;
		var canvas = document.getElementById('canvas');
		var ctx = canvas.getContext('2d');
		var imageInput = document.getElementById("file-input");
		var colorInput = document.getElementById("back-color-input");
		var overlayInput = document.getElementById("overlay-input");
		var textInput = document.getElementById("text-input");
		var textSizeInput = document.getElementById("text-size-input");
		var textColorInput = document.getElementById("text-color-input");
		var textOpacityInput = document.getElementById("text-opacity-input");
		var saveButton = document.getElementById("save-button");
		var img = new Image();
		var mark = new Image();
		var text = textInput.value;
		var textSize = textSizeInput.value;
		var textX = 0;
		var textY = 0;
		var color = "#dad3b6";
		var textColor = "#000000";
		var textOpacity = 1;
		var fileName = "";
		var lightbox = document.getElementById("lightbox");
		var closeButton = document.getElementById("close-button");
		var result = document.getElementById("result");

		function resetCanvas() {
			ctx.fillStyle = color;
			ctx.fillRect(0, 0, canvasWidth, canvasHeight);
		}

		function drawImage() {
			var vPad = 32;
			var hPad = 32;
			var dstWidth = canvasWidth - hPad * 2;
			var dstHeight = canvasHeight - vPad * 2;
			var srcRatio = img.width / img.height;
			var dstRatio = dstWidth / dstHeight;

		    var scaleFactor;
		    if (srcRatio < dstRatio)
		        scaleFactor = dstHeight / img.height;
		    else
		        scaleFactor = dstWidth / img.width;

		    var totalWidth = img.width * scaleFactor;
		    var totalHeight = img.height * scaleFactor;

		    ctx.drawImage(img,
		    hPad + (dstWidth - totalWidth) / 2,
		    vPad + (dstHeight - totalHeight) / 2,
		    img.width * scaleFactor,
		    img.height * scaleFactor);
		}

		function drawOverlay() {
			/*ctx.shadowColor = "#333333" // string
			ctx.shadowOffsetX = 1; 
			ctx.shadowOffsetY = 1;
			ctx.shadowBlur = 4; // integer
			ctx.fillStyle = textColor;
			ctx.strokeStyle = textColor;
			ctx.font = textSize + "px sans-serif";
			ctx.globalAlpha = textOpacity;
			ctx.strokeText(text, textX, textY);
			ctx.globalAlpha = 1;*/
			var maskCanvas = document.getElementById('text-mask-canvas');
			ctx.drawImage(maskCanvas, textX, textY);
		}

		function render() {			
			resetCanvas();
			drawImage();			
			drawOverlay();
		}

		imageInput.addEventListener("change", function(e) {			
			img.onload = render;
			fileName = e.target.files[0].name;
			img.src = URL.createObjectURL(e.target.files[0]);
		});

		function onCanvasGesture(e) {
			textX = e.offsetX;
			textY = e.offsetY;
			render();
		}

		canvas.addEventListener("click", onCanvasGesture);
		textInput.addEventListener("change", function() {
			text = textInput.value;
			render();
		});
		textSizeInput.addEventListener("change", function() {
			textSize = textSizeInput.value;
			render();
		});
		textColorInput.addEventListener("change", function() {
			textColor = textColorInput.value;
			render();
		});
		textOpacityInput.addEventListener("change", function() {
			textOpacity = textOpacityInput.value;
			render();
		});

		colorInput.addEventListener("change", function() {
			color = colorInput.value;
			render();
		});


		closeButton.addEventListener("click", function () {
			lightbox.style.display = "none";
		});

		saveButton.addEventListener("click", function () {
			lightbox.style.display = "block";
			result.src = canvas.toDataURL("image/png");
			/*var link = document.getElementById('link');
		  	link.setAttribute('download', fileName);
		  	link.setAttribute('href', canvas.toDataURL("image/png").replace("image/png", "image/octet-stream"));
		  	link.click();*/
		});
		
	</script>
</body>
</html>